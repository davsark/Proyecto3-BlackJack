name: ğŸ° Compilar y Publicar Blackjack

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # 1. TRABAJO: SERVIDOR
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  build-server:
    name: ğŸ–¥ï¸ Compilar Servidor (Ubuntu)
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ Clonar el cÃ³digo
        uses: actions/checkout@v4

      - name: â˜• Configurar Java 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: ğŸ”‘ Dar permisos de ejecuciÃ³n a Gradle
        run: |
          echo -e "\033[1;34m[INFO] Otorgando permisos a gradlew...\033[0m"
          chmod +x gradlew

      - name: âš™ï¸ Compilar ZIP del Servidor
        run: |
          echo -e "\033[1;36m==================================================\033[0m"
          echo -e "\033[1;33mğŸ° INICIANDO COMPILACIÃ“N DEL SERVIDOR BLACKJACK...\033[0m"
          echo -e "\033[1;36m==================================================\033[0m"
          ./gradlew :server:distZip --console=rich
          echo -e "\033[1;32mâœ… Â¡CompilaciÃ³n del servidor completada con Ã©xito!\033[0m"

      - name: ğŸ“¤ Subir ZIP como artefacto
        uses: actions/upload-artifact@v4
        with:
          name: server-zip
          path: server/build/distributions/*.zip

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # 2. TRABAJO: CLIENTES (MATRIZ)
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  build-clients:
    name: ğŸ® Compilar Cliente (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [windows-latest, macos-latest, ubuntu-latest]
    steps:
      - name: ğŸ“¥ Clonar el cÃ³digo
        uses: actions/checkout@v4

      - name: â˜• Configurar Java 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: ğŸ”‘ Dar permisos a Gradle (Mac/Linux)
        if: runner.os != 'Windows'
        run: chmod +x gradlew

      - name: ğŸ“¦ Crear instalador nativo del Cliente
        run: |
          echo -e "\033[1;35m==================================================\033[0m"
          echo -e "\033[1;33mğŸ¨ EMPAQUETANDO CLIENTE PARA ${{ matrix.os }}...\033[0m"
          echo -e "\033[1;35m==================================================\033[0m"
          ./gradlew :composeApp:packageDistributionForCurrentOS --console=rich
          echo -e "\033[1;32mâœ… Â¡Instalador de ${{ matrix.os }} generado correctamente!\033[0m"

      - name: ğŸ“¤ Subir instalador como artefacto
        uses: actions/upload-artifact@v4
        with:
          name: client-${{ matrix.os }}
          path: composeApp/build/compose/binaries/main/app/*

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # 3. TRABAJO: PUBLICACIÃ“N
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  create-release:
    name: ğŸš€ Publicar en GitHub Releases
    needs: [build-server, build-clients]
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ§² Descargar todos los artefactos temporales
        uses: actions/download-artifact@v4
        with:
          path: release-files
          merge-multiple: true

      - name: ğŸ“¢ Imprimir resumen de archivos generados
        run: |
          echo -e "\033[1;36m==================================================\033[0m"
          echo -e "\033[1;32mğŸ“¦ ARCHIVOS LISTOS PARA LA RELEASE:\033[0m"
          echo -e "\033[1;36m==================================================\033[0m"
          ls -lh release-files/

      - name: ğŸ‰ Crear Release oficial
        uses: softprops/action-gh-release@v2
        with:
          files: release-files/*
          generate_release_notes: true